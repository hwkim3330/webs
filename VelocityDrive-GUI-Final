#!/bin/bash
#############################################################
# VelocityDRIVE Touch GUI - Final Production Launcher
# One-click execution with hardware detection and demo mode
#############################################################

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Logo
echo -e "${BLUE}"
cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â•‘
â•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â•šâ–ˆâ–ˆâ•—  â•‘
â•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â•šâ–ˆâ–ˆâ•— â•‘
â•‘  â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•”â• â•‘
â•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•  â•‘
â•‘    â•šâ•â•â•â•  â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•â•šâ•â•   â•šâ•â•   â•šâ•â•   â•‘
â•‘                                                              â•‘
â•‘              DRIVE Touch GUI - Complete Control Center       â•‘
â•‘                    Microchip LAN9662 Platform               â•‘
â•‘                     ğŸš€ Powered by Claude Code               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}"

echo -e "${CYAN}ğŸ¯ VelocityDRIVE Touch GUI v2025.07.12${NC}"
echo -e "${CYAN}ğŸ“± Touch-Optimized Web Interface for Raspberry Pi${NC}"
echo ""

# Check Python
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}âŒ Python3ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.${NC}"
    echo "ì„¤ì¹˜: sudo apt-get install python3 python3-pip"
    exit 1
fi

# Install dependencies
echo -e "${YELLOW}ğŸ“¦ ì˜ì¡´ì„± íŒ¨í‚¤ì§€ í™•ì¸ ì¤‘...${NC}"
MISSING_PACKAGES=()

for package in flask flask-cors pyserial; do
    if ! python3 -c "import ${package//-/_}" 2>/dev/null; then
        MISSING_PACKAGES+=($package)
    fi
done

if [ ${#MISSING_PACKAGES[@]} -gt 0 ]; then
    echo -e "${YELLOW}ğŸ“¥ í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘: ${MISSING_PACKAGES[*]}${NC}"
    pip3 install --break-system-packages "${MISSING_PACKAGES[@]}" 2>/dev/null || \
    pip3 install "${MISSING_PACKAGES[@]}" 2>/dev/null
    echo -e "${GREEN}âœ… íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ${NC}"
fi

# Kill existing servers
pkill -f "python3 app" 2>/dev/null

# Hardware detection
echo -e "${YELLOW}ğŸ” í•˜ë“œì›¨ì–´ ê°ì§€ ì¤‘...${NC}"
HARDWARE_FOUND=false

if [ -e "/dev/ttyACM0" ] || [ -e "/dev/ttyUSB0" ]; then
    HARDWARE_FOUND=true
    echo -e "${GREEN}âœ… VelocityDRIVE í•˜ë“œì›¨ì–´ ê°ì§€ë¨${NC}"
fi

# Choose mode
if [ "$HARDWARE_FOUND" = true ]; then
    echo ""
    echo -e "${PURPLE}ğŸ›ï¸  ì‹¤í–‰ ëª¨ë“œ ì„ íƒ:${NC}"
    echo -e "  ${GREEN}1)${NC} í•˜ë“œì›¨ì–´ ëª¨ë“œ (ì‹¤ì œ LAN9662 ë³´ë“œ ì—°ê²°)"
    echo -e "  ${BLUE}2)${NC} ë°ëª¨ ëª¨ë“œ (ì‹œë®¬ë ˆì´ì…˜, í•˜ë“œì›¨ì–´ ë¶ˆí•„ìš”)"
    echo ""
    read -p "ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš” (1/2, ê¸°ë³¸ê°’: 1): " mode_choice

    if [ "$mode_choice" = "2" ]; then
        SERVER_FILE="app_demo.py"
        MODE_NAME="ë°ëª¨ ëª¨ë“œ"
        echo -e "${BLUE}ğŸ­ ë°ëª¨ ëª¨ë“œë¡œ ì‹œì‘í•©ë‹ˆë‹¤${NC}"
    else
        SERVER_FILE="app_complete.py"
        MODE_NAME="í•˜ë“œì›¨ì–´ ëª¨ë“œ"
        echo -e "${GREEN}ğŸ”§ í•˜ë“œì›¨ì–´ ëª¨ë“œë¡œ ì‹œì‘í•©ë‹ˆë‹¤${NC}"
    fi
else
    SERVER_FILE="app_demo.py"
    MODE_NAME="ë°ëª¨ ëª¨ë“œ"
    echo -e "${BLUE}ğŸ­ í•˜ë“œì›¨ì–´ê°€ ê°ì§€ë˜ì§€ ì•Šì•„ ë°ëª¨ ëª¨ë“œë¡œ ì‹œì‘í•©ë‹ˆë‹¤${NC}"
fi

# Start server
echo ""
echo -e "${GREEN}ğŸš€ ${MODE_NAME} ì„œë²„ ì‹œì‘ ì¤‘...${NC}"

if [ ! -f "$SERVER_FILE" ]; then
    echo -e "${RED}âŒ ì„œë²„ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $SERVER_FILE${NC}"
    exit 1
fi

python3 "$SERVER_FILE" > /tmp/velocitydrive.log 2>&1 &
SERVER_PID=$!

# Wait for server
sleep 3

# Check if server started
if kill -0 $SERVER_PID 2>/dev/null; then
    echo -e "${GREEN}âœ… ì„œë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! (PID: $SERVER_PID)${NC}"
    echo ""

    # Display access info
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}ğŸŒ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì†:${NC}"
    echo ""
    echo -e "   ${YELLOW}ğŸ  ë¡œì»¬ ì ‘ì†:${NC} ${CYAN}http://localhost:8080${NC}"

    # Get IP address
    IP=$(ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v 127.0.0.1 | head -1)
    if [ ! -z "$IP" ]; then
        echo -e "   ${YELLOW}ğŸŒ ì™¸ë¶€ ì ‘ì†:${NC} ${CYAN}http://$IP:8080${NC}"
    fi

    echo ""
    echo -e "${GREEN}ğŸ“± í„°ì¹˜ìŠ¤í¬ë¦° ìµœì í™”:${NC}"
    echo -e "   â€¢ 44px ì´ìƒ í„°ì¹˜ íƒ€ê²Ÿ"
    echo -e "   â€¢ 7ì¸ì¹˜ ë””ìŠ¤í”Œë ˆì´ ìµœì í™”"
    echo -e "   â€¢ í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ ì§€ì›"
    echo ""

    if [ "$SERVER_FILE" = "app_demo.py" ]; then
        echo -e "${BLUE}ğŸ­ ë°ëª¨ ëª¨ë“œ íŠ¹ì§•:${NC}"
        echo -e "   â€¢ í•˜ë“œì›¨ì–´ ì—†ì´ ëª¨ë“  ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"
        echo -e "   â€¢ ì‹¤ì‹œê°„ ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜"
        echo -e "   â€¢ ì™„ì „í•œ CLI ëª…ë ¹ì–´ ì§€ì›"
        echo ""
    else
        echo -e "${GREEN}ğŸ”§ í•˜ë“œì›¨ì–´ ëª¨ë“œ íŠ¹ì§•:${NC}"
        echo -e "   â€¢ ì‹¤ì œ LAN9662 ë³´ë“œ ì œì–´"
        echo -e "   â€¢ ì‹¤ì‹œê°„ TSN ëª¨ë‹ˆí„°ë§"
        echo -e "   â€¢ íŒì›¨ì–´ ì—…ë°ì´íŠ¸ ì§€ì›"
        echo ""
    fi

    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

    # Auto-open browser
    if [ -n "$DISPLAY" ]; then
        echo ""
        echo -e "${YELLOW}ğŸ”„ ë¸Œë¼ìš°ì € ìë™ ì‹¤í–‰ ì¤‘...${NC}"
        sleep 1

        if command -v xdg-open &> /dev/null; then
            xdg-open http://localhost:8080 2>/dev/null &
        elif command -v chromium-browser &> /dev/null; then
            chromium-browser --kiosk http://localhost:8080 2>/dev/null &
        elif command -v firefox &> /dev/null; then
            firefox http://localhost:8080 2>/dev/null &
        fi

        echo -e "${GREEN}âœ… ë¸Œë¼ìš°ì €ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤!${NC}"
    else
        echo -e "${YELLOW}ğŸ’¡ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ ì£¼ì†Œë¡œ ì ‘ì†í•˜ì„¸ìš”${NC}"
    fi

    echo ""
    echo -e "${PURPLE}ğŸ® ì§€ì›ë˜ëŠ” ê¸°ëŠ¥:${NC}"
    echo -e "   â€¢ Device Management (ë””ë°”ì´ìŠ¤ ê´€ë¦¬)"
    echo -e "   â€¢ YANG Operations (YANG ë°ì´í„° ì¡°ì‘)"
    echo -e "   â€¢ TSN Configuration (PTP, TAS, CBS, FRER)"
    echo -e "   â€¢ Protocol Support (CoAP, MUP1)"
    echo -e "   â€¢ Firmware Management (íŒì›¨ì–´ ê´€ë¦¬)"
    echo -e "   â€¢ Advanced Operations (Import/Export)"
    echo -e "   â€¢ Console Interface (ì§ì ‘ CLI ì œì–´)"
    echo ""
    echo -e "${RED}ğŸ›‘ ì¢…ë£Œí•˜ë ¤ë©´ Ctrl+Cë¥¼ ëˆ„ë¥´ì„¸ìš”${NC}"
    echo ""

    # Signal handling
    trap 'echo -e "\n${RED}ğŸ›‘ ì„œë²„ ì¢…ë£Œ ì¤‘...${NC}"; kill $SERVER_PID 2>/dev/null; echo -e "${GREEN}âœ… ì•ˆì „í•˜ê²Œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤${NC}"; exit 0' INT TERM

    # Monitor server
    while kill -0 $SERVER_PID 2>/dev/null; do
        sleep 1
    done

    echo -e "${RED}âš ï¸  ì„œë²„ê°€ ì˜ˆê¸°ì¹˜ ì•Šê²Œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤${NC}"
    echo "ë¡œê·¸ í™•ì¸: cat /tmp/velocitydrive.log"

else
    echo -e "${RED}âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨!${NC}"
    echo "ë¡œê·¸ í™•ì¸: cat /tmp/velocitydrive.log"
    echo ""
    echo "ë¬¸ì œ í•´ê²°:"
    echo "  1. í¬íŠ¸ 8080ì´ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸: sudo netstat -tlnp | grep 8080"
    echo "  2. Python íŒ¨í‚¤ì§€ ì¬ì„¤ì¹˜: pip3 install --force-reinstall flask flask-cors pyserial"
    echo "  3. ê¶Œí•œ í™•ì¸: ls -la $SERVER_FILE"
    exit 1
fi